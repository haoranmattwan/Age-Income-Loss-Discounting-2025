<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Replication Code (Python): Age, Income, and the Discounting of Delayed Monetary Losses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="analysis_Py_files/libs/clipboard/clipboard.min.js"></script>
<script src="analysis_Py_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="analysis_Py_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="analysis_Py_files/libs/quarto-html/popper.min.js"></script>
<script src="analysis_Py_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="analysis_Py_files/libs/quarto-html/anchor.min.js"></script>
<link href="analysis_Py_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="analysis_Py_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="analysis_Py_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="analysis_Py_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="analysis_Py_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Replication Code (Python): Age, Income, and the Discounting of Delayed Monetary Losses</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This Jupyter Notebook provides a complete Python-based replication of the analyses from the publication:</p>
<blockquote class="blockquote">
<p>Wan, H., Myerson, J., Green, L., Strube, M. J., &amp; Hale, S. (2025). Age, income, and the discounting of delayed monetary losses. <em>The Journals of Gerontology, Series B: Psychological Sciences and Social Sciences, 80</em>(11), gbaf162. https://doi.org/10.1093/geronb/gbaf162</p>
</blockquote>
<p>The original analysis, conducted in R, has been translated into a Python workflow. This notebook demonstrates proficiency in replicating complex statistical analyses across different programming ecosystems.</p>
<section id="workflow-overview" class="level3">
<h3 class="anchored" data-anchor-id="workflow-overview">Workflow Overview</h3>
<ol type="1">
<li><strong>Setup</strong>: Imports all necessary Python libraries and defines custom functions for modeling and plotting.</li>
<li><strong>Data Processing</strong>: Loads the raw data and cleans it using <code>pandas</code>, preparing it for analysis.</li>
<li><strong>Descriptive &amp; Correlational Analyses</strong>: Replicates the paper’s descriptive statistics, visualizations (Figure 1), and correlation tables using <code>matplotlib</code>, <code>seaborn</code>, and <code>pingouin</code>.</li>
<li><strong>Hypothesis Testing</strong>: Fits the main Bayesian multilevel beta regression models from the paper (Table 3) using <code>pymc</code>.</li>
<li><strong>Supplementary Analyses</strong>: Fits additional models to test the roles of depression and overall distress.</li>
<li><strong>Interaction Plots</strong>: Generates visualizations for the key model interactions (Figure 4), demonstrating the ability to interpret and communicate complex model findings.</li>
</ol>
<p>The data for this study are available in the Supplementary Material at the publisher’s website.</p>
<div id="15b9a932" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Environment Setup ---</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This cell installs all the required Python packages.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># It is commented out by default. Uncomment and run this cell if the packages are not yet installed in your environment.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># import sys</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># !{sys.executable} -m pip install openpyxl pandas numpy scipy statsmodels pymc arviz matplotlib seaborn pingouin patsy jax jaxlib</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="73d60a76" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. SETUP: IMPORTS AND CUSTOM FUNCTIONS ---</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Core Libraries ---</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> patsy</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> curve_fit</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistics and Modeling ---</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pingouin <span class="im">as</span> pg</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Visualization ---</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Global Settings ---</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">'</span><span class="sc">{:.3f}</span><span class="st">'</span>.<span class="bu">format</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Custom Functions ---</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scale_var(series):</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (series <span class="op">-</span> series.mean()) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> series.std())</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hyperboloid(delay, k, s):</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Mathematical function for hyperboloid discounting."""</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(k) <span class="op">*</span> delay)<span class="op">**</span>s</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_plot_theme(ax, title<span class="op">=</span><span class="st">""</span>, xlabel<span class="op">=</span><span class="st">""</span>, ylabel<span class="op">=</span><span class="st">""</span>):</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Applies a consistent, publication-quality theme to a Matplotlib axes object."""</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(xlabel, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, labelpad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(ylabel, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, labelpad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> ax.spines.values():</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        spine.set_edgecolor(<span class="st">'black'</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        spine.set_linewidth(<span class="dv">1</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    ax.set_facecolor(<span class="st">'white'</span>)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">False</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">10</span>, direction<span class="op">=</span><span class="st">'in'</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax.get_legend():</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        ax.legend(frameon<span class="op">=</span><span class="va">False</span>, title_fontproperties<span class="op">=</span>{<span class="st">'weight'</span>:<span class="st">'bold'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: We use np.trapz(y, x) for the trapezoidal rule, which is the direct</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co"># equivalent of the custom R function.</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> betaMLM_pymc(formula, data, <span class="bu">file</span><span class="op">=</span><span class="va">None</span>):</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a><span class="co">    Fits a Bayesian multilevel beta regression model using PyMC, mirroring brms.</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co">    This function uses patsy to parse the model formula, constructs the model in </span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">    PyMC with weakly informative priors analogous to the R script, and samples </span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">    from the posterior. It includes a file-caching mechanism to avoid re-running.</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="co">        formula (str): A patsy-style formula (e.g., "y ~ x1 + (1|ID)").</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="co">                       Random effects are limited to a simple random intercept on ID.</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="co">        data (pd.DataFrame): The dataframe containing the model variables.</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="co">        file (str, optional): Path to save/load the fitted model object, </span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a><span class="co">                              enabling caching. Defaults to None.</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="co">        arviz.InferenceData: The fitted model object containing posterior samples.</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">file</span> <span class="kw">and</span> os.path.exists(<span class="bu">file</span>):</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loading cached model from </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> az.from_netcdf(<span class="bu">file</span>)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> {}</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'(1|ID)'</span> <span class="kw">in</span> formula:</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        fixed_formula <span class="op">=</span> formula.partition(<span class="st">'(1|ID)'</span>)[<span class="dv">0</span>].strip().rstrip(<span class="st">'+'</span>).strip()</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>        has_re <span class="op">=</span> <span class="va">True</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>        id_idx, id_cats <span class="op">=</span> pd.factorize(data[<span class="st">'ID'</span>])</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>        coords[<span class="st">'ID_dim'</span>] <span class="op">=</span> id_cats</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>        fixed_formula <span class="op">=</span> formula</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>        has_re <span class="op">=</span> <span class="va">False</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    y_patsy, X_patsy <span class="op">=</span> patsy.dmatrices(fixed_formula, data<span class="op">=</span>data)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    y_name <span class="op">=</span> y_patsy.design_info.column_names[<span class="dv">0</span>]</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    y_data <span class="op">=</span> np.asarray(y_patsy).ravel()</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    X_data <span class="op">=</span> np.asarray(X_patsy)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    X_cols <span class="op">=</span> X_patsy.design_info.column_names</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    y_data[y_data <span class="op">==</span> <span class="dv">1</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> np.finfo(<span class="bu">float</span>).eps</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    y_data[y_data <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> np.finfo(<span class="bu">float</span>).eps</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> model:</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>        intercept <span class="op">=</span> pm.Normal(<span class="st">'Intercept'</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>        slopes <span class="op">=</span> pm.Cauchy(<span class="st">'slopes'</span>, alpha<span class="op">=</span><span class="dv">0</span>, beta<span class="op">=</span><span class="fl">2.5</span>, shape<span class="op">=</span>X_data.shape[<span class="dv">1</span>] <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>        betas <span class="op">=</span> pm.math.concatenate([[intercept], slopes])</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>        nu <span class="op">=</span> pm.HalfNormal(<span class="st">'nu'</span>, sigma<span class="op">=</span><span class="dv">100</span>) <span class="co"># Precision parameter</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> has_re:</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>            sigma_id <span class="op">=</span> pm.HalfCauchy(<span class="st">'sigma_id'</span>, beta<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>            z_id <span class="op">=</span> pm.Normal(<span class="st">'z_id'</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">1</span>, dims<span class="op">=</span><span class="st">'ID_dim'</span>)</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>            intercept_id <span class="op">=</span> pm.Deterministic(<span class="st">'intercept_id'</span>, z_id <span class="op">*</span> sigma_id, dims<span class="op">=</span><span class="st">'ID_dim'</span>)</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>        eta <span class="op">=</span> pm.math.dot(X_data, betas)</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> has_re:</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>            eta <span class="op">+=</span> intercept_id[id_idx]</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> pm.math.invlogit(eta)</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>        pm.Beta(y_name, mu<span class="op">=</span>mu, nu<span class="op">=</span>nu, observed<span class="op">=</span>y_data)</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>        idata <span class="op">=</span> pm.sample(</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>            draws<span class="op">=</span><span class="dv">2000</span>, </span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>            tune<span class="op">=</span><span class="dv">2000</span>, </span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>            chains<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>            cores<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>            progressbar<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>            target_accept<span class="op">=</span><span class="fl">0.95</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Unpack the 'slopes' variable into named variables for a cleaner summary</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>        slopes_data <span class="op">=</span> idata.posterior[<span class="st">'slopes'</span>]</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>        slope_names <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> X_cols <span class="cf">if</span> col <span class="op">!=</span> <span class="st">'Intercept'</span>]</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the name of the dimension to index along</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>        dim_name <span class="op">=</span> [dim <span class="cf">for</span> dim <span class="kw">in</span> slopes_data.dims <span class="cf">if</span> dim <span class="kw">not</span> <span class="kw">in</span> (<span class="st">'chain'</span>, <span class="st">'draw'</span>)][<span class="dv">0</span>]</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(slope_names):</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a new variable for each slope, correctly indexed</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>            idata.posterior[name] <span class="op">=</span> slopes_data.isel({dim_name: i})</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Drop the original multi-dimensional 'slopes' variable</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>        idata.posterior <span class="op">=</span> idata.posterior.drop_vars(<span class="st">'slopes'</span>)</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">file</span>:</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Saving model to </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>        idata.to_netcdf(<span class="bu">file</span>)</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> idata</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pymc_summary(idata, rownames<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a formatted summary table from a fitted PyMC model, mirroring brm_summary.</span></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a><span class="co">        idata (arviz.InCaseData): The fitted model object.</span></span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a><span class="co">        rownames (list, optional): A list of strings to rename the model parameters </span></span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a><span class="co">                                  in the final output table.</span></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.DataFrame: A formatted summary table with posterior medians, standard </span></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a><span class="co">                      deviations, and probability of direction (pd).</span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>    stat_funcs <span class="op">=</span> {</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Est."</span>: np.median,</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SE"</span>: np.std</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get fixed-effect variable names, excluding random effect parameters</span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and the precision parameter 'nu'.</span></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>    var_names <span class="op">=</span> [v <span class="cf">for</span> v <span class="kw">in</span> idata.posterior.data_vars <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> </span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>                 [<span class="st">'intercept_id'</span>, <span class="st">'z_id'</span>, <span class="st">'sigma_id'</span>, <span class="st">'nu'</span>]]</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>    summary_df <span class="op">=</span> az.summary(</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>        idata, </span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>        var_names<span class="op">=</span>var_names, </span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>        kind<span class="op">=</span><span class="st">"stats"</span>, </span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>        stat_funcs<span class="op">=</span>stat_funcs, </span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>        extend<span class="op">=</span><span class="va">False</span></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>    pd_values <span class="op">=</span> []</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> summary_df.index:</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the var string directly to az.extract</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>        samples <span class="op">=</span> az.extract(idata, var_names<span class="op">=</span>var).values</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>        pd_val <span class="op">=</span> np.mean(samples <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>        pd_values.append(<span class="bu">max</span>(pd_val, <span class="dv">1</span> <span class="op">-</span> pd_val))</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>    summary_df[<span class="st">'pd'</span>] <span class="op">=</span> pd_values</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> format_num(x):</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span>.replace(<span class="st">"0."</span>, <span class="st">"."</span>)</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>    est_formatted <span class="op">=</span> summary_df[<span class="st">'Est.'</span>].<span class="bu">apply</span>(format_num)</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>    se_formatted <span class="op">=</span> summary_df[<span class="st">'SE'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"(</span><span class="sc">{</span>format_num(x)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>    summary_df[<span class="st">"Est.(SE)"</span>] <span class="op">=</span> est_formatted <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> se_formatted</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> format_pd(x):</span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isclose(x, <span class="fl">1.0</span>):</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"&gt;.999"</span></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> format_num(x)</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>    summary_df[<span class="st">"pd"</span>] <span class="op">=</span> summary_df[<span class="st">"pd"</span>].<span class="bu">apply</span>(format_pd)</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>    summary_df.index <span class="op">=</span> summary_df.index.<span class="bu">str</span>.replace(<span class="st">"I("</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">False</span>).<span class="bu">str</span>.replace(<span class="st">" ** 2"</span>, <span class="st">"^2"</span>, regex<span class="op">=</span><span class="va">False</span>).<span class="bu">str</span>.replace(<span class="st">")"</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rownames:</span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>        summary_df.index <span class="op">=</span> rownames</span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> summary_df[[<span class="st">'Est.(SE)'</span>, <span class="st">'pd'</span>]]</span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a Python translation of the R power analysis function.</span></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: It uses statsmodels GLM (not a mixed model) as a frequentist approximation</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a><span class="co"># of glmmTMB, as a direct equivalent for Beta GLMMs is not available.</span></span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SimPower_MLM(n_ID, beta1, beta2, nu<span class="op">=</span><span class="fl">12.2</span>, sigma<span class="op">=</span><span class="fl">0.944</span>, n_sim<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simulation-based power analysis for multilevel beta regression."""</span></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Running </span><span class="sc">{</span>n_sim<span class="sc">}</span><span class="ss"> simulations..."</span>)</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_sim):</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Data generation logic translated from R</span></span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>        group_ids <span class="op">=</span> np.repeat(np.arange(n_ID <span class="op">*</span> <span class="dv">6</span>), <span class="dv">3</span>)</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>        ages_list <span class="op">=</span> [np.random.uniform(<span class="dv">20</span>, <span class="dv">29</span>, n_ID), np.random.uniform(<span class="dv">30</span>, <span class="dv">39</span>, n_ID),</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>                     np.random.uniform(<span class="dv">40</span>, <span class="dv">49</span>, n_ID), np.random.uniform(<span class="dv">50</span>, <span class="dv">59</span>, n_ID),</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>                     np.random.uniform(<span class="dv">60</span>, <span class="dv">69</span>, n_ID), np.random.uniform(<span class="dv">70</span>, <span class="dv">80</span>, n_ID)]</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>        Age <span class="op">=</span> np.repeat(np.concatenate(ages_list), <span class="dv">3</span>)</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>        Income <span class="op">=</span> np.repeat(np.random.binomial(<span class="dv">4</span>, <span class="fl">0.5</span>, n_ID <span class="op">*</span> <span class="dv">6</span>) <span class="op">+</span> <span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> np.repeat(np.random.normal(<span class="dv">0</span>, sigma, n_ID <span class="op">*</span> <span class="dv">6</span>), <span class="dv">3</span>)</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>        eta <span class="op">=</span> b <span class="op">+</span> (beta1 <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> Age.std())) <span class="op">*</span> Age <span class="op">+</span> (beta2 <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> Income.std())) <span class="op">*</span> Income</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span>eta))</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>        AuC <span class="op">=</span> np.random.beta(mu <span class="op">*</span> nu, (<span class="dv">1</span> <span class="op">-</span> mu) <span class="op">*</span> nu)</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>        AuC <span class="op">=</span> np.clip(AuC, <span class="fl">1e-9</span>, <span class="dv">1</span> <span class="op">-</span> <span class="fl">1e-9</span>)</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>        sim_dat <span class="op">=</span> pd.DataFrame({<span class="st">'ID'</span>: group_ids, <span class="st">'Age'</span>: Age, <span class="st">'Income'</span>: Income, <span class="st">'AuC'</span>: AuC})</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit models</span></span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>            dat_20_80 <span class="op">=</span> sim_dat.copy()</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>            dat_20_80[<span class="st">'Age_std'</span>] <span class="op">=</span> (dat_20_80[<span class="st">'Age'</span>] <span class="op">-</span> dat_20_80[<span class="st">'Age'</span>].mean()) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> dat_20_80[<span class="st">'Age'</span>].std())</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>            dat_35_80 <span class="op">=</span> sim_dat[sim_dat[<span class="st">'Age'</span>] <span class="op">&gt;=</span> <span class="dv">35</span>].copy()</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>            dat_35_80[<span class="st">'Age_std'</span>] <span class="op">=</span> (dat_35_80[<span class="st">'Age'</span>] <span class="op">-</span> dat_35_80[<span class="st">'Age'</span>].mean()) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> dat_35_80[<span class="st">'Age'</span>].std())</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>            dat_35_80[<span class="st">'Income_std'</span>] <span class="op">=</span> (dat_35_80[<span class="st">'Income'</span>] <span class="op">-</span> dat_35_80[<span class="st">'Income'</span>].mean()) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> dat_35_80[<span class="st">'Income'</span>].std())</span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Using GLM as approximation of GLMM</span></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>            fit1 <span class="op">=</span> smf.glm(<span class="st">'AuC ~ Age_std'</span>, data<span class="op">=</span>dat_20_80, family<span class="op">=</span>sm.families.Binomial()).fit()</span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>            fit2 <span class="op">=</span> smf.glm(<span class="st">'AuC ~ Age_std + Income_std'</span>, data<span class="op">=</span>dat_35_80, family<span class="op">=</span>sm.families.Binomial()).fit()</span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>            results.append([fit1.pvalues[<span class="st">'Age_std'</span>], fit2.pvalues[<span class="st">'Age_std'</span>], fit2.pvalues[<span class="st">'Income_std'</span>]])</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>            results.append([np.nan, np.nan, np.nan])</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>    p_values <span class="op">=</span> pd.DataFrame(results, columns<span class="op">=</span>[<span class="st">'p1'</span>, <span class="st">'p2'</span>, <span class="st">'p3'</span>])</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>    power <span class="op">=</span> (p_values <span class="op">&lt;</span> <span class="fl">0.05</span>).mean()</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> power.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f77f059a" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. DATA LOADING AND PROCESSING ---</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data from the specified sheet in the Excel file</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>Disc_Raw <span class="op">=</span> pd.read_excel(<span class="st">"Supplementary Data.xlsx"</span>, sheet_name<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Feature Engineering and Cleaning ---</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Age_Group factor for plotting</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>age_bins <span class="op">=</span> [<span class="dv">19</span>, <span class="dv">34</span>, <span class="dv">50</span>, <span class="dv">64</span>, <span class="dv">80</span>]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>age_labels <span class="op">=</span> [<span class="st">"20-34"</span>, <span class="st">"35-50"</span>, <span class="st">"51-64"</span>, <span class="st">"65-80"</span>]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>Disc_Raw[<span class="st">'age_grp_factor'</span>] <span class="op">=</span> pd.cut(Disc_Raw[<span class="st">'Age'</span>], bins<span class="op">=</span>age_bins, labels<span class="op">=</span>age_labels)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-transform Amount</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>amount_map <span class="op">=</span> {<span class="dv">1</span>: <span class="dv">150</span>, <span class="dv">3</span>: <span class="dv">30000</span>, <span class="dv">2</span>: <span class="dv">2500</span>}</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>Disc_Raw[<span class="st">'Amount_log'</span>] <span class="op">=</span> np.log(Disc_Raw[<span class="st">'Amount'</span>].<span class="bu">map</span>(amount_map))</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure correct data types</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Income'</span>, <span class="st">'Education'</span>, <span class="st">'Distress'</span>, <span class="st">'Anxiety'</span>, <span class="st">'Depression'</span>]:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    Disc_Raw[col] <span class="op">=</span> pd.to_numeric(Disc_Raw[col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Group-Level Dataframe for Plotting ---</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>Disc_Grp <span class="op">=</span> Disc_Raw.copy()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>Disc_Grp[<span class="st">'Amount'</span>] <span class="op">=</span> Disc_Grp[<span class="st">'Amount'</span>].<span class="bu">map</span>({<span class="dv">150</span>: <span class="st">"$150"</span>, <span class="dv">2500</span>: <span class="st">"$2,500"</span>, <span class="dv">30000</span>: <span class="st">"$30,000"</span>})</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>Disc_Grp[<span class="st">'Amount'</span>] <span class="op">=</span> pd.Categorical(Disc_Grp[<span class="st">'Amount'</span>], categories<span class="op">=</span>[<span class="st">"$150"</span>, <span class="st">"$2,500"</span>, <span class="st">"$30,000"</span>], ordered<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>Disc_Grp <span class="op">=</span> Disc_Grp.groupby([<span class="st">'age_grp_factor'</span>, <span class="st">'Amount'</span>, <span class="st">'Delay'</span>], observed<span class="op">=</span><span class="va">True</span>).agg(Mean_RSV<span class="op">=</span>(<span class="st">'RSV'</span>, <span class="st">'mean'</span>)).reset_index()</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Calculate Area under the Curve (AuC) for Each Individual ---</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>AuC_ID <span class="op">=</span> Disc_Raw.sort_values(<span class="st">'Delay'</span>).groupby([<span class="st">'ID'</span>, <span class="st">'Amount'</span>]).<span class="bu">apply</span>(</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> g: np.trapz(y<span class="op">=</span>g[<span class="st">'RSV'</span>], x<span class="op">=</span>g[<span class="st">'Delay'</span>] <span class="op">/</span> g[<span class="st">'Delay'</span>].<span class="bu">max</span>())</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>).reset_index(name<span class="op">=</span><span class="st">'AuC'</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Join back demographic information</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>demographics <span class="op">=</span> Disc_Raw.drop_duplicates(subset<span class="op">=</span><span class="st">'ID'</span>).drop(columns<span class="op">=</span>[<span class="st">'Amount'</span>, <span class="st">'Delay'</span>, <span class="st">'RSV'</span>, <span class="st">'Amount_log'</span>])</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>AuC_ID <span class="op">=</span> pd.merge(AuC_ID, demographics, on<span class="op">=</span><span class="st">'ID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Clip AuC values for Beta regression</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>AuC_ID[<span class="st">'AuC'</span>] <span class="op">=</span> np.clip(AuC_ID[<span class="st">'AuC'</span>], <span class="fl">1e-9</span>, <span class="dv">1</span> <span class="op">-</span> <span class="fl">1e-9</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for Model 1</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>DL_dat1 <span class="op">=</span> AuC_ID[AuC_ID[<span class="st">'Age'</span>] <span class="op">&gt;=</span> <span class="dv">35</span>].copy()</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>DL_dat1[<span class="st">'Age_std'</span>] <span class="op">=</span> scale_var(DL_dat1[<span class="st">'Age'</span>])</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for Model 2</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>DL_dat2 <span class="op">=</span> AuC_ID[(AuC_ID[<span class="st">'Age'</span>] <span class="op">&gt;=</span> <span class="dv">35</span>) <span class="op">&amp;</span> AuC_ID[<span class="st">'Income'</span>].notna()].copy()</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Age'</span>, <span class="st">'Income'</span>]:</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    DL_dat2[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_std'</span>] <span class="op">=</span> scale_var(DL_dat2[col])</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for Models 3, S1, S3</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>DL_dat3 <span class="op">=</span> AuC_ID[(AuC_ID[<span class="st">'Age'</span>] <span class="op">&gt;=</span> <span class="dv">35</span>) <span class="op">&amp;</span> AuC_ID[<span class="st">'Income'</span>].notna() <span class="op">&amp;</span> AuC_ID[<span class="st">'Distress'</span>].notna()].copy()</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Age'</span>, <span class="st">'Income'</span>, <span class="st">'Anxiety'</span>, <span class="st">'Depression'</span>, <span class="st">'Distress'</span>]:</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    DL_dat3[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_std'</span>] <span class="op">=</span> scale_var(DL_dat3[col])</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for Full Models (4, S2, S4)</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>DL_dat4 <span class="op">=</span> AuC_ID[</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    (AuC_ID[<span class="st">'Age'</span>] <span class="op">&gt;=</span> <span class="dv">35</span>) <span class="op">&amp;</span> (AuC_ID[<span class="st">'Income'</span>].notna()) <span class="op">&amp;</span> (AuC_ID[<span class="st">'Gender'</span>].notna()) <span class="op">&amp;</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    (AuC_ID[<span class="st">'Education'</span>].notna()) <span class="op">&amp;</span> (AuC_ID[<span class="st">'Distress'</span>].notna()) <span class="op">&amp;</span> (AuC_ID[<span class="st">'Health'</span>].notna())</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Age'</span>, <span class="st">'Amount'</span>, <span class="st">'Income'</span>, <span class="st">'Education'</span>, <span class="st">'Anxiety'</span>, <span class="st">'Depression'</span>, <span class="st">'Distress'</span>, <span class="st">'Health'</span>]:</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    DL_dat4[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_std'</span>] <span class="op">=</span> scale_var(DL_dat4[col])</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>DL_dat4[<span class="st">'Gender_c'</span>] <span class="op">=</span> DL_dat4[<span class="st">'Gender'</span>] <span class="op">-</span> DL_dat4[<span class="st">'Gender'</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="descriptive-correlational-analyses" class="level2">
<h2 class="anchored" data-anchor-id="descriptive-correlational-analyses">Descriptive &amp; Correlational Analyses</h2>
<p>This section replicates the descriptive results from the paper, including the visualization of group-level discounting functions (Figure 1), goodness-of-fit statistics for the hyperboloid model, reliability of the AuC measure, and the correlation matrices for key variables.</p>
<div id="2b0e02c3" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. DESCRIPTIVE &amp; CORRELATIONAL ANALYSES ---</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4.1 Figure 1 Replication: Group-Level Discounting Functions ---</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Plot ---</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {<span class="st">"$150"</span>: <span class="st">"#33a02c"</span>, <span class="st">"$2,500"</span>: <span class="st">"#ff7f00"</span>, <span class="st">"$30,000"</span>: <span class="st">"#1f78b4"</span>}</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>shapes <span class="op">=</span> {<span class="st">"$150"</span>: <span class="st">"s"</span>, <span class="st">"$2,500"</span>: <span class="st">"^"</span>, <span class="st">"$30,000"</span>: <span class="st">"o"</span>}</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>linestyles <span class="op">=</span> {<span class="st">"$150"</span>: <span class="st">"dotted"</span>, <span class="st">"$2,500"</span>: <span class="st">"dashed"</span>, <span class="st">"$30,000"</span>: <span class="st">"solid"</span>}</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (age_group, group_df) <span class="kw">in</span> <span class="bu">enumerate</span>(Disc_Grp.groupby(<span class="st">'age_grp_factor'</span>, observed<span class="op">=</span><span class="va">True</span>)):</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> amount, amount_df <span class="kw">in</span> group_df.groupby(<span class="st">'Amount'</span>, observed<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        ax.plot(amount_df[<span class="st">'Delay'</span>], amount_df[<span class="st">'Mean_RSV'</span>], marker<span class="op">=</span>shapes[amount], linestyle<span class="op">=</span><span class="st">''</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>colors[amount], label<span class="op">=</span>amount, markersize<span class="op">=</span><span class="dv">8</span>, markeredgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit and plot curve</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>            popt, _ <span class="op">=</span> curve_fit(hyperboloid, amount_df[<span class="st">'Delay'</span>], amount_df[<span class="st">'Mean_RSV'</span>], p0<span class="op">=</span>[<span class="op">-</span><span class="dv">4</span>, <span class="fl">0.5</span>])</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            x_pred <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">10</span>, <span class="dv">130</span>, <span class="dv">200</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            ax.plot(x_pred, hyperboloid(x_pred, <span class="op">*</span>popt), color<span class="op">=</span>colors[amount], linestyle<span class="op">=</span>linestyles[amount], lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">RuntimeError</span>:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Curve fit failed for </span><span class="sc">{</span>age_group<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>amount<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    set_plot_theme(ax, title<span class="op">=</span>age_group, xlabel<span class="op">=</span><span class="st">"Delay (months)"</span> <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"Delay (months)"</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="op">-</span><span class="fl">0.005</span>, <span class="fl">1.005</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(<span class="op">-</span><span class="dv">10</span>, <span class="dv">130</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a single legend</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>handles, labels <span class="op">=</span> axes[<span class="dv">0</span>].get_legend_handles_labels()</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>fig.legend(handles, labels, loc<span class="op">=</span><span class="st">'center right'</span>, title<span class="op">=</span><span class="st">'Amount'</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.0</span>, <span class="fl">0.5</span>))</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Relative Subjective Value"</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.95</span>, <span class="dv">1</span>])</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Goodness-of-Fit for Group-Level Hyperboloid Functions ---</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- R-squared for Group-Level Hyperboloid Fits ---"</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>r2_results <span class="op">=</span> Disc_Grp.groupby([<span class="st">'age_grp_factor'</span>, <span class="st">'Amount'</span>], observed<span class="op">=</span><span class="va">True</span>).<span class="bu">apply</span>(</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> grp: r2_score(grp[<span class="st">'Mean_RSV'</span>], hyperboloid(grp[<span class="st">'Delay'</span>], <span class="op">*</span>curve_fit(hyperboloid, grp[<span class="st">'Delay'</span>], grp[<span class="st">'Mean_RSV'</span>], p0<span class="op">=</span>[<span class="op">-</span><span class="dv">4</span>, <span class="fl">0.5</span>])[<span class="dv">0</span>]))</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>).unstack()</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>display(r2_results)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Test for the "Amount Effect" ---</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- P-values for Amount Effect within each Age Group ---"</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co"># analysis for a within-subjects factor within each level of a between-subjects group.</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>amount_effect_pvals <span class="op">=</span> AuC_ID.groupby(<span class="st">'age_grp_factor'</span>, observed<span class="op">=</span><span class="va">True</span>).<span class="bu">apply</span>(</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> g: pg.rm_anova(data<span class="op">=</span>g, dv<span class="op">=</span><span class="st">'AuC'</span>, within<span class="op">=</span><span class="st">'Amount'</span>, subject<span class="op">=</span><span class="st">'ID'</span>)[<span class="st">'p-unc'</span>][<span class="dv">0</span>]</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>).rename(<span class="st">'p_value'</span>).to_frame()</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>display(amount_effect_pvals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_Py_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- R-squared for Group-Level Hyperboloid Fits ---</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Amount</th>
<th data-quarto-table-cell-role="th">$150</th>
<th data-quarto-table-cell-role="th">$2,500</th>
<th data-quarto-table-cell-role="th">$30,000</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">age_grp_factor</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20-34</td>
<td>0.956</td>
<td>0.983</td>
<td>0.997</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35-50</td>
<td>0.973</td>
<td>0.976</td>
<td>0.965</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">51-64</td>
<td>0.898</td>
<td>0.878</td>
<td>0.955</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">65-80</td>
<td>0.925</td>
<td>0.926</td>
<td>0.890</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- P-values for Amount Effect within each Age Group ---</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">p_value</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">age_grp_factor</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20-34</td>
<td>0.002</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35-50</td>
<td>0.003</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">51-64</td>
<td>0.340</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">65-80</td>
<td>0.527</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="reliability-and-correlational-analyses" class="level3">
<h3 class="anchored" data-anchor-id="reliability-and-correlational-analyses">Reliability and Correlational Analyses</h3>
<p>This section assesses the internal consistency of the Area under the Curve (AuC) measure across the three different loss amounts. It also replicates the correlation matrices from the paper for both the full sample (ages 20-80) and the primary analysis sample (ages 35-80).</p>
<div id="5c411316" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4.2 Reliability of AuC Measure (Cronbach's Alpha) ---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"--- Reliability of AuC Measure (Cronbach's Alpha) ---"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot the data to have one row per participant and one column per amount</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>reliability_df <span class="op">=</span> AuC_ID.pivot(index<span class="op">=</span><span class="st">'ID'</span>, columns<span class="op">=</span><span class="st">'Amount'</span>, values<span class="op">=</span><span class="st">'AuC'</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Cronbach's Alpha</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>display(pg.cronbach_alpha(data<span class="op">=</span>reliability_df))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4.3 Correlation Matrix for All Participants (Aged 20-80) ---</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Correlation Matrix for All Participants (Aged 20-80) ---"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># First, average the repeated measures for each participant</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>Cor_df_full <span class="op">=</span> AuC_ID.groupby(<span class="st">'ID'</span>).agg({</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Age'</span>: <span class="st">'mean'</span>, <span class="st">'Income'</span>: <span class="st">'mean'</span>, <span class="st">'Education'</span>: <span class="st">'mean'</span>, <span class="st">'Gender'</span>: <span class="st">'mean'</span>, </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Distress'</span>: <span class="st">'mean'</span>, <span class="st">'Anxiety'</span>: <span class="st">'mean'</span>, <span class="st">'Depression'</span>: <span class="st">'mean'</span>, </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Health'</span>: <span class="st">'mean'</span>, <span class="st">'AuC'</span>: <span class="st">'mean'</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and display the Pearson correlation matrix</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>display(Cor_df_full.corr(method<span class="op">=</span><span class="st">'pearson'</span>).<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4.4 Correlation Matrix for Participants Aged 35-80 (Table 2 Replication) ---</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Correlation Matrix for Participants Aged 35-80 ---"</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the data to the specified age range, then average and correlate</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>Cor_df_35plus <span class="op">=</span> AuC_ID[AuC_ID[<span class="st">'Age'</span>] <span class="op">&gt;=</span> <span class="dv">35</span>].groupby(<span class="st">'ID'</span>).agg({</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Age'</span>: <span class="st">'mean'</span>, <span class="st">'Income'</span>: <span class="st">'mean'</span>, <span class="st">'Education'</span>: <span class="st">'mean'</span>, <span class="st">'Gender'</span>: <span class="st">'mean'</span>, </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Distress'</span>: <span class="st">'mean'</span>, <span class="st">'Anxiety'</span>: <span class="st">'mean'</span>, <span class="st">'Depression'</span>: <span class="st">'mean'</span>, </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Health'</span>: <span class="st">'mean'</span>, <span class="st">'AuC'</span>: <span class="st">'mean'</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>display(Cor_df_35plus.corr(method<span class="op">=</span><span class="st">'pearson'</span>).<span class="bu">round</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Reliability of AuC Measure (Cronbach's Alpha) ---</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>(np.float64(0.8601565041438437), array([0.839, 0.879]))</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Correlation Matrix for All Participants (Aged 20-80) ---</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">Gender</th>
<th data-quarto-table-cell-role="th">Distress</th>
<th data-quarto-table-cell-role="th">Anxiety</th>
<th data-quarto-table-cell-role="th">Depression</th>
<th data-quarto-table-cell-role="th">Health</th>
<th data-quarto-table-cell-role="th">AuC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Age</td>
<td>1.000</td>
<td>-0.025</td>
<td>-0.009</td>
<td>-0.002</td>
<td>-0.292</td>
<td>-0.338</td>
<td>-0.180</td>
<td>-0.081</td>
<td>0.189</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Income</td>
<td>-0.025</td>
<td>1.000</td>
<td>0.384</td>
<td>-0.083</td>
<td>-0.146</td>
<td>-0.133</td>
<td>-0.132</td>
<td>0.229</td>
<td>0.094</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Education</td>
<td>-0.009</td>
<td>0.384</td>
<td>1.000</td>
<td>-0.036</td>
<td>-0.158</td>
<td>-0.126</td>
<td>-0.167</td>
<td>0.186</td>
<td>0.032</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Gender</td>
<td>-0.002</td>
<td>-0.083</td>
<td>-0.036</td>
<td>1.000</td>
<td>0.098</td>
<td>0.132</td>
<td>0.035</td>
<td>-0.023</td>
<td>-0.042</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Distress</td>
<td>-0.292</td>
<td>-0.146</td>
<td>-0.158</td>
<td>0.098</td>
<td>1.000</td>
<td>0.929</td>
<td>0.886</td>
<td>-0.458</td>
<td>-0.142</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Anxiety</td>
<td>-0.338</td>
<td>-0.133</td>
<td>-0.126</td>
<td>0.132</td>
<td>0.929</td>
<td>1.000</td>
<td>0.650</td>
<td>-0.347</td>
<td>-0.168</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Depression</td>
<td>-0.180</td>
<td>-0.132</td>
<td>-0.167</td>
<td>0.035</td>
<td>0.886</td>
<td>0.650</td>
<td>1.000</td>
<td>-0.498</td>
<td>-0.067</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Health</td>
<td>-0.081</td>
<td>0.229</td>
<td>0.186</td>
<td>-0.023</td>
<td>-0.458</td>
<td>-0.347</td>
<td>-0.498</td>
<td>1.000</td>
<td>0.079</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">AuC</td>
<td>0.189</td>
<td>0.094</td>
<td>0.032</td>
<td>-0.042</td>
<td>-0.142</td>
<td>-0.168</td>
<td>-0.067</td>
<td>0.079</td>
<td>1.000</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Correlation Matrix for Participants Aged 35-80 ---</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">Gender</th>
<th data-quarto-table-cell-role="th">Distress</th>
<th data-quarto-table-cell-role="th">Anxiety</th>
<th data-quarto-table-cell-role="th">Depression</th>
<th data-quarto-table-cell-role="th">Health</th>
<th data-quarto-table-cell-role="th">AuC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Age</td>
<td>1.000</td>
<td>-0.031</td>
<td>0.011</td>
<td>-0.029</td>
<td>-0.281</td>
<td>-0.325</td>
<td>-0.174</td>
<td>0.026</td>
<td>0.206</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Income</td>
<td>-0.031</td>
<td>1.000</td>
<td>0.388</td>
<td>-0.132</td>
<td>-0.207</td>
<td>-0.193</td>
<td>-0.177</td>
<td>0.286</td>
<td>0.114</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Education</td>
<td>0.011</td>
<td>0.388</td>
<td>1.000</td>
<td>-0.100</td>
<td>-0.189</td>
<td>-0.171</td>
<td>-0.173</td>
<td>0.224</td>
<td>0.017</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Gender</td>
<td>-0.029</td>
<td>-0.132</td>
<td>-0.100</td>
<td>1.000</td>
<td>0.153</td>
<td>0.174</td>
<td>0.095</td>
<td>-0.036</td>
<td>-0.045</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Distress</td>
<td>-0.281</td>
<td>-0.207</td>
<td>-0.189</td>
<td>0.153</td>
<td>1.000</td>
<td>0.932</td>
<td>0.893</td>
<td>-0.515</td>
<td>-0.149</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Anxiety</td>
<td>-0.325</td>
<td>-0.193</td>
<td>-0.171</td>
<td>0.174</td>
<td>0.932</td>
<td>1.000</td>
<td>0.670</td>
<td>-0.411</td>
<td>-0.169</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Depression</td>
<td>-0.174</td>
<td>-0.177</td>
<td>-0.173</td>
<td>0.095</td>
<td>0.893</td>
<td>0.670</td>
<td>1.000</td>
<td>-0.540</td>
<td>-0.084</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Health</td>
<td>0.026</td>
<td>0.286</td>
<td>0.224</td>
<td>-0.036</td>
<td>-0.515</td>
<td>-0.411</td>
<td>-0.540</td>
<td>1.000</td>
<td>0.096</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">AuC</td>
<td>0.206</td>
<td>0.114</td>
<td>0.017</td>
<td>-0.045</td>
<td>-0.149</td>
<td>-0.169</td>
<td>-0.084</td>
<td>0.096</td>
<td>1.000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="hypothesis-testing-bayesian-multilevel-models" class="level2">
<h2 class="anchored" data-anchor-id="hypothesis-testing-bayesian-multilevel-models">Hypothesis Testing: Bayesian Multilevel Models</h2>
<p>This section replicates the main hypothesis tests from the paper, corresponding to Table 3. A series of four Bayesian multilevel beta regression models are fitted to test the effects of age, income, anxiety, and other covariates on AuC for participants aged 35 and older.</p>
<div id="de59e4c7" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. HYPOTHESIS </span><span class="al">TESTING</span><span class="co">: MAIN MODELS ---</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Model 1: AuC ~ Age + Age^2 ---</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Tests for a linear and quadratic effect of age on discounting.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"--- Model 1: AuC ~ Age + Age^2 ---"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>idata_mod1b <span class="op">=</span> betaMLM_pymc(<span class="st">"AuC ~ Age_std + I(Age_std**2) + (1|ID)"</span>, DL_dat1)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pymc_summary(idata_mod1b))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Model 2: AuC ~ Age + Age^2 + Income ---</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Adds income as a predictor.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Model 2: AuC ~ Age + Age^2 + Income ---"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>idata_mod2 <span class="op">=</span> betaMLM_pymc(<span class="st">"AuC ~ Age_std + I(Age_std**2) + Income_std + (1|ID)"</span>, DL_dat2)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pymc_summary(idata_mod2))</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Model 3: AuC ~ Age + Age^2 + Income + Anxiety ---</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Adds anxiety as a predictor.</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Model 3: AuC ~ Age + Age^2 + Income + Anxiety ---"</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>idata_mod3 <span class="op">=</span> betaMLM_pymc(<span class="st">"AuC ~ Age_std + I(Age_std**2) + Income_std + Anxiety_std + (1|ID)"</span>, DL_dat3)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pymc_summary(idata_mod3))</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Model 4: Full Model with Covariates and Age Interactions ---</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># The full model includes all covariates and their interactions with age.</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Model 4: Full Model with Covariates and Age Interactions ---"</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>formula_mod4 <span class="op">=</span> <span class="st">"AuC ~ (Age_std + Income_std + Anxiety_std + Amount_std + Education_std + Gender_c + Health_std)**2 + I(Age_std**2) + (1|ID)"</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>idata_mod4 <span class="op">=</span> betaMLM_pymc(formula_mod4, DL_dat4)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pymc_summary(idata_mod4))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Model 1: AuC ~ Age + Age^2 ---</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Initializing NUTS using jitter+adapt_diag...
Sequential sampling (1 chains in 1 job)
NUTS: [Intercept, slopes, nu, sigma_id, z_id]
Sampling 1 chain for 2_000 tune and 2_000 draw iterations (2_000 + 2_000 draws total) took 23 seconds.
Only one chain was sampled, this makes it impossible to run some convergence checks
Initializing NUTS using jitter+adapt_diag...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>               Est.(SE)     pd
Intercept   .994 (.090)  &gt;.999
Age_std     .444 (.116)  &gt;.999
Age_std^2  -.573 (.277)   .981

--- Model 2: AuC ~ Age + Age^2 + Income ---</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sequential sampling (1 chains in 1 job)
NUTS: [Intercept, slopes, nu, sigma_id, z_id]
Sampling 1 chain for 2_000 tune and 2_000 draw iterations (2_000 + 2_000 draws total) took 23 seconds.
Only one chain was sampled, this makes it impossible to run some convergence checks
Initializing NUTS using jitter+adapt_diag...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                Est.(SE)     pd
Intercept   1.015 (.092)  &gt;.999
Age_std      .467 (.116)  &gt;.999
Age_std^2   -.633 (.274)   .989
Income_std   .279 (.119)   .986

--- Model 3: AuC ~ Age + Age^2 + Income + Anxiety ---</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sequential sampling (1 chains in 1 job)
NUTS: [Intercept, slopes, nu, sigma_id, z_id]
Sampling 1 chain for 2_000 tune and 2_000 draw iterations (2_000 + 2_000 draws total) took 23 seconds.
Only one chain was sampled, this makes it impossible to run some convergence checks
Initializing NUTS using jitter+adapt_diag...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Est.(SE)     pd
Intercept    1.003 (.092)  &gt;.999
Age_std       .372 (.132)   .999
Age_std^2    -.591 (.282)   .974
Income_std    .249 (.120)   .981
Anxiety_std  -.303 (.128)   .991

--- Model 4: Full Model with Covariates and Age Interactions ---</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sequential sampling (1 chains in 1 job)
NUTS: [Intercept, slopes, nu, sigma_id, z_id]
Sampling 1 chain for 2_000 tune and 2_000 draw iterations (2_000 + 2_000 draws total) took 36 seconds.
Only one chain was sampled, this makes it impossible to run some convergence checks</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                               Est.(SE)     pd
Intercept                  1.004 (.109)  &gt;.999
Age_std                     .371 (.138)  1.000
Income_std                  .279 (.147)   .970
Anxiety_std                -.243 (.158)   .933
Amount_std                 -.066 (.047)   .926
Education_std              -.068 (.147)   .678
Gender_c                   -.032 (.123)   .606
Health_std                  .092 (.141)   .748
Age_std:Income_std          .267 (.299)   .805
Age_std:Anxiety_std        -.180 (.305)   .694
Age_std:Amount_std          .254 (.096)   .996
Age_std:Education_std       .086 (.273)   .615
Age_std:Gender_c           -.005 (.277)   .509
Age_std:Health_std         -.101 (.311)   .629
Income_std:Anxiety_std      .453 (.319)   .929
Income_std:Amount_std      -.012 (.101)   .549
Income_std:Education_std    .088 (.271)   .620
Income_std:Gender_c        -.182 (.270)   .743
Income_std:Health_std      -.025 (.304)   .532
Anxiety_std:Amount_std      .044 (.106)   .663
Anxiety_std:Education_std   .011 (.263)   .516
Anxiety_std:Gender_c       -.025 (.285)   .537
Anxiety_std:Health_std     -.192 (.269)   .753
Amount_std:Education_std    .092 (.099)   .827
Amount_std:Gender_c        -.162 (.091)   .957
Amount_std:Health_std      -.146 (.105)   .919
Education_std:Gender_c      .445 (.277)   .942
Education_std:Health_std    .172 (.343)   .703
Gender_c:Health_std        -.134 (.273)   .691
Age_std^2                  -.668 (.324)   .983</code></pre>
</div>
</div>
</section>
<section id="supplementary-analyses-depression-and-distress-models" class="level2">
<h2 class="anchored" data-anchor-id="supplementary-analyses-depression-and-distress-models">Supplementary Analyses: Depression and Distress Models</h2>
<p>The paper notes that while anxiety was a significant predictor of discounting, depression and overall psychological distress were not (when controlling for age and income). This section presents the models that confirm these findings.</p>
<div id="53f72354" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 6. SUPPLEMENTARY ANALYSES: DEPRESSION &amp; DISTRESS ---</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Model S1: Test effect of Depression ---</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"--- Model S1: AuC ~ Age + Age^2 + Income + Depression ---"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>idata_modS1 <span class="op">=</span> betaMLM_pymc(<span class="st">"AuC ~ Age_std + I(Age_std**2) + Income_std + Depression_std + (1|ID)"</span>, DL_dat3)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pymc_summary(idata_modS1))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Model S3: Test effect of Distress ---</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Model S3: AuC ~ Age + Age^2 + Income + Distress ---</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>idata_modS3 <span class="op">=</span> betaMLM_pymc(<span class="st">"AuC ~ Age_std + I(Age_std**2) + Income_std + Distress_std + (1|ID)"</span>, DL_dat3)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pymc_summary(idata_modS3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Model S1: AuC ~ Age + Age^2 + Income + Depression ---</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Initializing NUTS using jitter+adapt_diag...
Sequential sampling (1 chains in 1 job)
NUTS: [Intercept, slopes, nu, sigma_id, z_id]
Sampling 1 chain for 2_000 tune and 2_000 draw iterations (2_000 + 2_000 draws total) took 23 seconds.
Only one chain was sampled, this makes it impossible to run some convergence checks
Initializing NUTS using jitter+adapt_diag...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                    Est.(SE)     pd
Intercept       1.004 (.095)  &gt;.999
Age_std          .460 (.121)  &gt;.999
Age_std^2       -.570 (.289)   .977
Income_std       .285 (.122)   .993
Depression_std  -.057 (.122)   .672

--- Model S3: AuC ~ Age + Age^2 + Income + Distress ---
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sequential sampling (1 chains in 1 job)
NUTS: [Intercept, slopes, nu, sigma_id, z_id]
Sampling 1 chain for 2_000 tune and 2_000 draw iterations (2_000 + 2_000 draws total) took 23 seconds.
Only one chain was sampled, this makes it impossible to run some convergence checks</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                  Est.(SE)     pd
Intercept     1.004 (.097)  &gt;.999
Age_std        .401 (.131)  &gt;.999
Age_std^2     -.579 (.284)   .984
Income_std     .258 (.124)   .978
Distress_std  -.192 (.129)   .935</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>